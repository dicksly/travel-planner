<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze API æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-waiting { background: #ffc107; }
        .status-running { background: #17a2b8; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .config-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .config-info code {
            background: #1a1a1a;
            color: #00ff00;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Coze API è¿æ¥æµ‹è¯•</h1>
        
        <div class="config-info">
            <h3>ğŸ“‹ å½“å‰é…ç½®</h3>
            <p>APIç«¯ç‚¹: <code id="api-endpoint">æ£€æŸ¥ä¸­...</code></p>
            <p>Bot ID: <code id="bot-id">æ£€æŸ¥ä¸­...</code></p>
            <p>Token: <code id="token-preview">æ£€æŸ¥ä¸­...</code></p>
            <p>å¯ç”¨çœŸå®AI: <span id="real-ai-status">æ£€æŸ¥ä¸­...</span></p>
        </div>

        <div class="test-section">
            <h3>ğŸ” è¿æ¥æµ‹è¯•</h3>
            <p>
                <span id="connection-status" class="status-indicator status-waiting"></span>
                <span id="connection-text">ç­‰å¾…æµ‹è¯•</span>
            </p>
            <button id="test-connection" class="test-btn">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button id="test-api" class="test-btn">ğŸ¤– æµ‹è¯•APIè°ƒç”¨</button>
            <button id="clear-log" class="test-btn">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div id="log-output" class="log-output">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let testingInProgress = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeConfig();
            initializeButtons();
        });

        // åˆå§‹åŒ–é…ç½®æ˜¾ç¤º
        function initializeConfig() {
            if (typeof CONFIG !== 'undefined') {
                document.getElementById('api-endpoint').textContent = CONFIG.COZE_API.endpoint;
                document.getElementById('bot-id').textContent = CONFIG.COZE_API.bot_id;
                document.getElementById('token-preview').textContent = CONFIG.COZE_API.token.substring(0, 20) + '...';
                document.getElementById('real-ai-status').textContent = CONFIG.APP.enableRealAI ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨';
            } else {
                log('âŒ æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶');
            }
        }

        // åˆå§‹åŒ–æŒ‰é’®
        function initializeButtons() {
            document.getElementById('test-connection').addEventListener('click', testConnection);
            document.getElementById('test-api').addEventListener('click', testAPI);
            document.getElementById('clear-log').addEventListener('click', clearLog);
        }

        // æ—¥å¿—è¾“å‡º
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('log-output').textContent = '';
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(status, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            if (testingInProgress) return;
            
            testingInProgress = true;
            updateStatus('running', 'æµ‹è¯•ä¸­...');
            
            try {
                log('ğŸ” å¼€å§‹è¿æ¥æµ‹è¯•...');
                log(`ğŸ“¡ ç›®æ ‡ç«¯ç‚¹: ${CONFIG.COZE_API.endpoint}`);
                
                // ç®€å•çš„è¿æ¥æµ‹è¯•
                const response = await fetch(CONFIG.COZE_API.endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                
                log(`ğŸ“Š è¿æ¥çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`ğŸ”— å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                if (response.status === 200 || response.status === 204) {
                    updateStatus('success', 'è¿æ¥æˆåŠŸ');
                    log('âœ… è¿æ¥æµ‹è¯•é€šè¿‡');
                } else {
                    updateStatus('error', 'è¿æ¥å¤±è´¥');
                    log('âŒ è¿æ¥æµ‹è¯•å¤±è´¥');
                }
                
            } catch (error) {
                updateStatus('error', 'è¿æ¥é”™è¯¯');
                log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`);
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log('ğŸ’¡ å¯èƒ½çš„åŸå› :');
                    log('   - ç½‘ç»œè¿æ¥é—®é¢˜');
                    log('   - CORSè·¨åŸŸé™åˆ¶');
                    log('   - APIç«¯ç‚¹ä¸å¯è®¿é—®');
                }
            } finally {
                testingInProgress = false;
            }
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testAPI() {
            if (testingInProgress) return;
            
            testingInProgress = true;
            updateStatus('running', 'APIæµ‹è¯•ä¸­...');
            
            try {
                log('ğŸ¤– å¼€å§‹APIè°ƒç”¨æµ‹è¯•...');
                
                // æ£€æŸ¥é…ç½®
                if (!CONFIG.APP.enableRealAI) {
                    log('âš ï¸ çœŸå®AIåŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·å…ˆåœ¨config.jsä¸­è®¾ç½®enableRealAI: true');
                    updateStatus('error', 'é…ç½®é”™è¯¯');
                    return;
                }
                
                // ç”Ÿæˆæµ‹è¯•ç”¨æˆ·ID
                const userId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                // å‡†å¤‡æµ‹è¯•è¯·æ±‚
                const testRequest = {
                    bot_id: CONFIG.COZE_API.bot_id,
                    user_id: userId,
                    stream: true,
                    additional_messages: [
                        {
                            content: "ä½ å¥½ï¼Œè¯·ç®€å•å›å¤ä¸€å¥è¯æµ‹è¯•è¿æ¥ã€‚",
                            content_type: "text",
                            role: "user",
                            type: "question"
                        }
                    ],
                    parameters: {}
                };
                
                log('ğŸ“‹ è¯·æ±‚å‚æ•°:');
                log(JSON.stringify(testRequest, null, 2));
                
                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    log('â° è¯·æ±‚è¶…æ—¶ (30ç§’)');
                }, 30000);
                
                log('ğŸš€ å‘é€APIè¯·æ±‚...');
                
                const response = await fetch(CONFIG.COZE_API.endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.COZE_API.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRequest),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                log(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`ğŸ“Š å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ APIé”™è¯¯å“åº”: ${errorText}`);
                    updateStatus('error', `APIé”™è¯¯: ${response.status}`);
                    return;
                }
                
                // å¤„ç†æµå¼å“åº”
                log('ğŸ“¥ å¼€å§‹è¯»å–æµå¼å“åº”...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let messageCount = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        log('ğŸ æµå¼å“åº”è¯»å–å®Œæˆ');
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        messageCount++;
                        log(`ğŸ“¨ æ¶ˆæ¯ ${messageCount}: ${line}`);
                        
                        // è§£æäº‹ä»¶
                        try {
                            if (line.startsWith('event: ')) {
                                const event = line.substring(7).trim();
                                log(`ğŸ¯ äº‹ä»¶ç±»å‹: ${event}`);
                            } else if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6).trim();
                                if (dataStr === '[DONE]') {
                                    log('âœ… æµå¼å“åº”å®Œæˆ');
                                    break;
                                }
                                const data = JSON.parse(dataStr);
                                log(`ğŸ“„ æ•°æ®å†…å®¹: ${JSON.stringify(data, null, 2)}`);
                            }
                        } catch (parseError) {
                            log(`âš ï¸ è§£æé”™è¯¯: ${parseError.message}`);
                        }
                    }
                }
                
                updateStatus('success', 'APIæµ‹è¯•æˆåŠŸ');
                log('âœ… APIè°ƒç”¨æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                updateStatus('error', 'APIæµ‹è¯•å¤±è´¥');
                log(`âŒ APIæµ‹è¯•é”™è¯¯: ${error.message}`);
                log(`ğŸ” é”™è¯¯ç±»å‹: ${error.name}`);
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.name === 'AbortError') {
                    log('ğŸ’¡ è¯·æ±‚è¢«å–æ¶ˆæˆ–è¶…æ—¶');
                } else if (error.name === 'TypeError') {
                    log('ğŸ’¡ å¯èƒ½çš„åŸå› :');
                    log('   - ç½‘ç»œè¿æ¥é—®é¢˜');
                    log('   - CORSè·¨åŸŸé™åˆ¶');
                    log('   - æ— æ•ˆçš„APIç«¯ç‚¹');
                } else if (error.name === 'SyntaxError') {
                    log('ğŸ’¡ å¯èƒ½æ˜¯APIå“åº”æ ¼å¼é”™è¯¯');
                }
            } finally {
                testingInProgress = false;
            }
        }
    </script>
</body>
</html> 