<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze API 测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-waiting { background: #ffc107; }
        .status-running { background: #17a2b8; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .config-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .config-info code {
            background: #1a1a1a;
            color: #00ff00;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Coze API 连接测试</h1>
        
        <div class="config-info">
            <h3>📋 当前配置</h3>
            <p>API端点: <code id="api-endpoint">检查中...</code></p>
            <p>Bot ID: <code id="bot-id">检查中...</code></p>
            <p>Token: <code id="token-preview">检查中...</code></p>
            <p>启用真实AI: <span id="real-ai-status">检查中...</span></p>
        </div>

        <div class="test-section">
            <h3>🔍 连接测试</h3>
            <p>
                <span id="connection-status" class="status-indicator status-waiting"></span>
                <span id="connection-text">等待测试</span>
            </p>
            <button id="test-connection" class="test-btn">🔗 测试连接</button>
            <button id="test-api" class="test-btn">🤖 测试API调用</button>
            <button id="clear-log" class="test-btn">🗑️ 清空日志</button>
        </div>

        <div class="test-section">
            <h3>📊 实时日志</h3>
            <div id="log-output" class="log-output">等待测试...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // 全局状态
        let testingInProgress = false;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeConfig();
            initializeButtons();
        });

        // 初始化配置显示
        function initializeConfig() {
            if (typeof CONFIG !== 'undefined') {
                document.getElementById('api-endpoint').textContent = CONFIG.COZE_API.endpoint;
                document.getElementById('bot-id').textContent = CONFIG.COZE_API.bot_id;
                document.getElementById('token-preview').textContent = CONFIG.COZE_API.token.substring(0, 20) + '...';
                document.getElementById('real-ai-status').textContent = CONFIG.APP.enableRealAI ? '✅ 已启用' : '❌ 已禁用';
            } else {
                log('❌ 无法加载配置文件');
            }
        }

        // 初始化按钮
        function initializeButtons() {
            document.getElementById('test-connection').addEventListener('click', testConnection);
            document.getElementById('test-api').addEventListener('click', testAPI);
            document.getElementById('clear-log').addEventListener('click', clearLog);
        }

        // 日志输出
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // 清空日志
        function clearLog() {
            document.getElementById('log-output').textContent = '';
        }

        // 更新状态指示器
        function updateStatus(status, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = message;
        }

        // 测试连接
        async function testConnection() {
            if (testingInProgress) return;
            
            testingInProgress = true;
            updateStatus('running', '测试中...');
            
            try {
                log('🔍 开始连接测试...');
                log(`📡 目标端点: ${CONFIG.COZE_API.endpoint}`);
                
                // 简单的连接测试
                const response = await fetch(CONFIG.COZE_API.endpoint, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                
                log(`📊 连接状态: ${response.status} ${response.statusText}`);
                log(`🔗 响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                if (response.status === 200 || response.status === 204) {
                    updateStatus('success', '连接成功');
                    log('✅ 连接测试通过');
                } else {
                    updateStatus('error', '连接失败');
                    log('❌ 连接测试失败');
                }
                
            } catch (error) {
                updateStatus('error', '连接错误');
                log(`❌ 连接错误: ${error.message}`);
                
                // 详细错误分析
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log('💡 可能的原因:');
                    log('   - 网络连接问题');
                    log('   - CORS跨域限制');
                    log('   - API端点不可访问');
                }
            } finally {
                testingInProgress = false;
            }
        }

        // 测试API调用
        async function testAPI() {
            if (testingInProgress) return;
            
            testingInProgress = true;
            updateStatus('running', 'API测试中...');
            
            try {
                log('🤖 开始API调用测试...');
                
                // 检查配置
                if (!CONFIG.APP.enableRealAI) {
                    log('⚠️ 真实AI功能未启用，请先在config.js中设置enableRealAI: true');
                    updateStatus('error', '配置错误');
                    return;
                }
                
                // 生成测试用户ID
                const userId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                // 准备测试请求
                const testRequest = {
                    bot_id: CONFIG.COZE_API.bot_id,
                    user_id: userId,
                    stream: true,
                    additional_messages: [
                        {
                            content: "你好，请简单回复一句话测试连接。",
                            content_type: "text",
                            role: "user",
                            type: "question"
                        }
                    ],
                    parameters: {}
                };
                
                log('📋 请求参数:');
                log(JSON.stringify(testRequest, null, 2));
                
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    log('⏰ 请求超时 (30秒)');
                }, 30000);
                
                log('🚀 发送API请求...');
                
                const response = await fetch(CONFIG.COZE_API.endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.COZE_API.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRequest),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                log(`📡 响应状态: ${response.status} ${response.statusText}`);
                log(`📊 响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ API错误响应: ${errorText}`);
                    updateStatus('error', `API错误: ${response.status}`);
                    return;
                }
                
                // 处理流式响应
                log('📥 开始读取流式响应...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let messageCount = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        log('🏁 流式响应读取完成');
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        messageCount++;
                        log(`📨 消息 ${messageCount}: ${line}`);
                        
                        // 解析事件
                        try {
                            if (line.startsWith('event: ')) {
                                const event = line.substring(7).trim();
                                log(`🎯 事件类型: ${event}`);
                            } else if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6).trim();
                                if (dataStr === '[DONE]') {
                                    log('✅ 流式响应完成');
                                    break;
                                }
                                const data = JSON.parse(dataStr);
                                log(`📄 数据内容: ${JSON.stringify(data, null, 2)}`);
                            }
                        } catch (parseError) {
                            log(`⚠️ 解析错误: ${parseError.message}`);
                        }
                    }
                }
                
                updateStatus('success', 'API测试成功');
                log('✅ API调用测试完成');
                
            } catch (error) {
                updateStatus('error', 'API测试失败');
                log(`❌ API测试错误: ${error.message}`);
                log(`🔍 错误类型: ${error.name}`);
                
                // 详细错误分析
                if (error.name === 'AbortError') {
                    log('💡 请求被取消或超时');
                } else if (error.name === 'TypeError') {
                    log('💡 可能的原因:');
                    log('   - 网络连接问题');
                    log('   - CORS跨域限制');
                    log('   - 无效的API端点');
                } else if (error.name === 'SyntaxError') {
                    log('💡 可能是API响应格式错误');
                }
            } finally {
                testingInProgress = false;
            }
        }
    </script>
</body>
</html> 